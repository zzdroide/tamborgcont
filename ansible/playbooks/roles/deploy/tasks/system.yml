- name: Disable quiet boot
  ansible.builtin.replace:
    path: /etc/default/grub
    regexp: ^GRUB_CMDLINE_LINUX_DEFAULT="quiet (.+)
    replace: GRUB_CMDLINE_LINUX_DEFAULT="\1
  become: true
  register: dqb

- name: Update-grub
  ansible.builtin.command: update-grub
  when: dqb.changed
  become: true

- name: Add silence-console.service
  ansible.builtin.copy:
    src: files/silence-console.service
    dest: /etc/systemd/system/silence-console.service
    owner: root
    group: root
    mode: 0644
  become: true

- name: Enable and start silence-console.service
  ansible.builtin.systemd:
    name: silence-console.service
    state: started
    enabled: true
  become: true

- name: Check if firmware-realtek could be useful
  ansible.builtin.shell: 'set -o pipefail && dmesg | grep -q " firmware: failed to load rtl_nic/"'
  become: true
  failed_when: false
  changed_when: false
  register: dmesgrep

- name: Install firmware-realtek
  when: dmesgrep.rc == 0
  become: true
  block:
    - name: Enable non-free archive
      ansible.builtin.replace:
        path: /etc/apt/sources.list
        regexp: ^deb(|-src) (\S+) bullseye main$
        replace: deb\1 \2 bullseye main non-free

    - name: Install the package
      ansible.builtin.apt:
        name: firmware-realtek
        state: present
        update_cache: true
