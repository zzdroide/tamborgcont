- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: Verify resulting authorized_keys
      ansible.builtin.script: verify_ak.sh
      changed_when: false

    - name: Verify shell prompt
      ansible.builtin.script: verify_shell.sh {{ item }}
      become: true
      loop:
        - "{{ ansible_user }}"
        - borg
      changed_when: false

    - name: Authorize ssh localhost
      # ansible.posix.authorized_key would require loading pubkey from remote...
      ansible.builtin.script: auth_ssh_localhost.sh
      changed_when: true

    - name: Verify ssh
      ansible.builtin.script: verify_ssh.sh
      changed_when: true  # hook.sh

    - name: Verify Borg binary
      become: true
      become_user: borg
      ansible.builtin.command: /home/borg/.local/bin/borg --version
      changed_when: false
      register: borg_version
      failed_when: borg_version.stdout != 'borg 2.0.0b4'
